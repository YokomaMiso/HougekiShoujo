using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using static UnityEngine.Rendering.DebugUI;

public class SelectRoomCanvasBehavior : MonoBehaviour
{
    enum SELECT_ROOM_BUTTON_ID { UPDATE = 0, JOIN, RANDOM, BACK_TO_TITLE, MAX_NUM };

    Image[] buttons = new Image[(int)SELECT_ROOM_BUTTON_ID.MAX_NUM];
    Image createButton;
    Image joinButton;
    Image randomButton;
    Image backTitleButton;

    //ボタンのカーソル
    int selectButtonNum = 0;
    //ボタンの最大数
    const int buttonItemNum = 4;
    //カーソル移動可能かどうか
    bool isCanSelect = true;

    //joinButtonを押したかどうか
    bool selectJoin;

    //ルームbannerの親
    GameObject roomBanners;

    //ルームバナーのカーソル
    public int selectRoomBannerNum = 0;
    //ボタンの最大数
    const int roomBannerItemNum = 8;

    //ルームバナーリスト
    List<RoomBanner> roomBannerList = new List<RoomBanner>();

    [SerializeField] GameObject connectingWindowPrefab;
    GameObject connectingWindowInstance;

    void Start()
    {
        OSCManager.OSCinstance.startPort = 50000;
        OSCManager.OSCinstance.pSRCB = this;

        for (int i = 0; i < (int)SELECT_ROOM_BUTTON_ID.MAX_NUM; i++) { buttons[i] = transform.GetChild(i).GetComponent<Image>(); }
        buttons[selectButtonNum].color = Color.yellow;

        roomBanners = transform.GetChild(4).gameObject;
        for (int i = 0; i < roomBannerItemNum; i++)
        {
            RoomBanner _room = roomBanners.transform.GetChild(i).GetComponent<RoomBanner>();
            _room.SetParent(this);

            //検索した部屋番号を適用
            roomBannerList.Add(_room);
        }

        connectingWindowInstance = Instantiate(connectingWindowPrefab, transform);
        OSCManager.OSCinstance.SearchRoom(true);
    }

    private void OnDestroy()
    {
        OSCManager.OSCinstance.pSRCB = null;
    }

    void Update()
    {
        //シーンチェンジのキャンバスが生成されていたら早期リターン
        if (Managers.instance.UsingCanvas()) { return; }

        //通信中ならリタ―ン
        if (connectingWindowInstance != null) { return; }

        //Joinが押されていない
        if (!selectJoin)
        {
            ChangeButtonSelectNum();
            DecideButtonSelect();
        }
        //Joinが押された
        else
        {
            ChangeRoomBannerSelectNum();
            DecideRoom();
            BackButtonSelect();
        }
    }

    void ChangeButtonSelectNum()
    {
        Vector2 value = InputManager.GetAxis<Vector2>(Vec2AxisActions.LStickAxis);

        //カーソル移動
        if (Mathf.Abs(value.y) > 0.7f)
        {
            if (isCanSelect)
            {
                buttons[selectButtonNum].color = Color.white;
                if (value.y < 0) { selectButtonNum = (selectButtonNum + 1) % buttonItemNum; }
                else { selectButtonNum = (selectButtonNum + buttonItemNum - 1) % buttonItemNum; }
                buttons[selectButtonNum].color = Color.yellow;
                isCanSelect = false;
            }
        }
        //前フレームの情報保存
        else if (Mathf.Abs(value.y) < 0.2f)
        {
            isCanSelect = true;
        }
    }

    void DecideBehavior()
    {
        switch ((SELECT_ROOM_BUTTON_ID)selectButtonNum)
        {
            case SELECT_ROOM_BUTTON_ID.UPDATE:
                //ConnectionSceneに移動し、部屋を作成

                connectingWindowInstance = Instantiate(connectingWindowPrefab, transform);
                OSCManager.OSCinstance.SearchRoom(false);

                //Managers.instance.ChangeScene(GAME_STATE.CONNECTION);
                //Managers.instance.ChangeState(GAME_STATE.CONNECTION);
                break;

            case SELECT_ROOM_BUTTON_ID.JOIN:
                selectJoin = true;
                isCanSelect = true;
                roomBanners.transform.GetChild(selectRoomBannerNum).GetComponent<Image>().color = Color.yellow;
                break;

            case SELECT_ROOM_BUTTON_ID.RANDOM:
                //ConnectionSceneに移動し、部屋に参加or作成
                //Managers.instance.ChangeScene(GAME_STATE.CONNECTION);
                //Managers.instance.ChangeState(GAME_STATE.CONNECTION);
                break;

            case SELECT_ROOM_BUTTON_ID.BACK_TO_TITLE:
                Managers.instance.ChangeScene(GAME_STATE.TITLE);
                Managers.instance.ChangeState(GAME_STATE.TITLE);
                break;
        }
    }

    void DecideButtonSelect()
    {
        //決定が押されていないならリターン
        if (!InputManager.GetKeyDown(BoolActions.SouthButton)) { return; }

        DecideBehavior();
    }
    public void DecideButtonSelectFromUI(int _selectButtonNum)
    {
        //シーンチェンジのキャンバスが生成されていたら早期リターン
        if (Managers.instance.UsingCanvas()) { return; }

        //通信中ならリタ―ン
        if (connectingWindowInstance != null) { return; }

        if (selectJoin) { return; }

        if (selectButtonNum == _selectButtonNum) { DecideBehavior(); }
        else 
        {
            buttons[selectButtonNum].color = Color.white;
            selectButtonNum = _selectButtonNum;
            buttons[selectButtonNum].color = Color.yellow;
        }
    }

    void ChangeRoomBannerSelectNum()
    {
        Vector2 value = InputManager.GetAxis<Vector2>(Vec2AxisActions.LStickAxis);

        //カーソル横移動
        if (Mathf.Abs(value.x) > 0.7f)
        {
            if (isCanSelect)
            {
                roomBanners.transform.GetChild(selectRoomBannerNum).GetComponent<Image>().color = Color.white;
                if (value.x < 0) { selectRoomBannerNum = (selectRoomBannerNum + roomBannerItemNum - 1) % roomBannerItemNum; }
                else { selectRoomBannerNum = (selectRoomBannerNum + 1) % roomBannerItemNum; }
                roomBanners.transform.GetChild(selectRoomBannerNum).GetComponent<Image>().color = Color.yellow;
                isCanSelect = false;
            }
        }
        //カーソル縦移動
        else if (Mathf.Abs(value.y) > 0.7f)
        {
            if (isCanSelect)
            {
                roomBanners.transform.GetChild(selectRoomBannerNum).GetComponent<Image>().color = Color.white;
                if (value.y < 0) { selectRoomBannerNum = (selectRoomBannerNum + 2) % roomBannerItemNum; }
                else { selectRoomBannerNum = (selectRoomBannerNum + roomBannerItemNum - 2) % roomBannerItemNum; }
                roomBanners.transform.GetChild(selectRoomBannerNum).GetComponent<Image>().color = Color.yellow;
                isCanSelect = false;
            }
        }
        //前フレームの情報保存
        else if (value.magnitude < 0.2f)
        {
            isCanSelect = true;
        }
    }

    void DecideRoom()
    {
        //決定が押されていないならリターン
        if (!InputManager.GetKeyDown(BoolActions.SouthButton)) { return; }

        OSCManager.OSCinstance.startPort = selectRoomBannerNum * 10 + 50000;

        //ConnectionSceneに移動し、選択した部屋に参加
        Managers.instance.ChangeScene(GAME_STATE.CONNECTION);
        Managers.instance.ChangeState(GAME_STATE.CONNECTION);
    }

    public void DecideRoomFromTouch(int _num)
    {
        if (!selectJoin) { return; }

        if (_num == selectRoomBannerNum)
        {
            OSCManager.OSCinstance.startPort = selectRoomBannerNum * 10 + 50000;

            //ConnectionSceneに移動し、選択した部屋に参加
            Managers.instance.ChangeScene(GAME_STATE.CONNECTION);
            Managers.instance.ChangeState(GAME_STATE.CONNECTION);
        }
        else
        {
            roomBanners.transform.GetChild(selectRoomBannerNum).GetComponent<Image>().color = Color.white;
            selectRoomBannerNum = _num;
            roomBanners.transform.GetChild(selectRoomBannerNum).GetComponent<Image>().color = Color.yellow;
        }
    }

    void BackButtonSelect()
    {
        //決定が押されてるならリターン
        if (InputManager.GetKeyDown(BoolActions.SouthButton)) { return; }
        //キャンセルが押されていないならリターン
        if (!InputManager.GetKeyDown(BoolActions.EastButton)) { return; }

        roomBanners.transform.GetChild(selectRoomBannerNum).GetComponent<Image>().color = Color.white;
        selectJoin = false;
    }

    public void SetRoomBannerData(AllGameData.AllData _allData, int i)
    {
        roomBannerList[i].SetData(_allData, i);
    }
}
